---
phase: 01.1-db-schema
plan: "03"
subsystem: auth
tags: [nextjs-middleware, supabase-auth, oauth, jwt, route-guard, family-membership]

# Dependency graph
requires:
  - phase: 01.1-02
    provides: lib/supabase/middleware.ts with updateSession(), lib/supabase/server.ts with createClient()

provides:
  - "middleware.ts — Next.js edge middleware that guards all routes (unauthenticated → /login, no family → /onboarding/welcome)"
  - "app/auth/callback/route.ts — OAuth code exchange handler for Google OAuth and email magic links"
  - "app/login/page.tsx — stub page preventing 404 during Phase 1.1 testing"
  - "app/onboarding/welcome/page.tsx — stub page preventing 404 during Phase 1.1 testing"

affects:
  - Phase 1.2 (onboarding) — will replace stub pages with full login/register/onboarding UI
  - Phase 1.4 (dashboard refactor) — may add family_id JWT claim to eliminate per-request DB roundtrip
  - All future phases — every page is now behind middleware auth guard

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Edge middleware for auth enforcement using updateSession() from @supabase/ssr"
    - "OAuth PKCE flow: /auth/callback exchanges code for session via exchangeCodeForSession()"
    - "Two-tier redirect: unauthenticated → /login, authenticated but no family → /onboarding/welcome"

key-files:
  created:
    - middleware.ts
    - app/auth/callback/route.ts
    - app/login/page.tsx
    - app/onboarding/welcome/page.tsx
  modified: []

key-decisions:
  - "Public paths include /login, /register, /auth/*, / — these never hit auth check"
  - "Onboarding paths (/onboarding/*) are auth-required but family-check exempt — user is creating their family"
  - "Family membership check adds ~50ms DB roundtrip per request — accepted for Phase 1.1, optimization deferred to Phase 1.4 (cache family_id in cookie or JWT claim)"
  - "Callback route supports optional 'next' param for deep-link redirects post-auth"
  - "Google OAuth requires Supabase Dashboard config (Site URL + Redirect URLs) and Google Cloud Console setup — Phase 1.2 user setup task"

patterns-established:
  - "Route guard pattern: updateSession() → check user → check family → return supabaseResponse"
  - "Stub pages created for routes referenced by middleware before full UI is built"
  - "OAuth callback at /auth/callback — Supabase's standard redirect target"

requirements-completed:
  - REQ-AUTH-007
  - REQ-AUTH-008

# Metrics
duration: 6min
completed: 2026-03-01
---

# Phase 1.1 Plan 03: Auth Middleware Summary

**Next.js edge middleware enforcing auth (unauthenticated → /login, no family → /onboarding/welcome) with OAuth code exchange at /auth/callback**

## Performance

- **Duration:** ~6 min
- **Started:** 2026-03-01T15:15:04Z
- **Completed:** 2026-03-01T15:21:00Z
- **Tasks:** 2
- **Files modified:** 4 created, 0 modified

## Accomplishments
- middleware.ts guards all app routes — unauthenticated users can no longer access any protected page
- Two-tier redirect: not logged in → /login, logged in but no family_members row → /onboarding/welcome
- /auth/callback route handler completes Google OAuth and email magic link flows via exchangeCodeForSession()
- Login and onboarding stub pages prevent 404s when middleware redirects during Phase 1.1 development

## Task Commits

Each task was committed atomically:

1. **Task 1: Create middleware.ts — route guard with auth and family membership check** - `73a7c5e` (feat)
2. **Task 2: Create app/auth/callback/route.ts — OAuth and email verification callback handler** - `5ea318b` (feat)

## Files Created/Modified
- `middleware.ts` — Next.js edge middleware; calls updateSession(), enforces auth and family membership; matcher excludes static assets
- `app/auth/callback/route.ts` — GET handler for Supabase OAuth redirect; exchanges code for session; redirects to /dashboard or /login?error=auth-failed
- `app/login/page.tsx` — Stub page (Phase 1.2 replaces with full login/register UI)
- `app/onboarding/welcome/page.tsx` — Stub page (Phase 1.2 replaces with full onboarding flow)

## Decisions Made
- Accepted ~50ms per-request DB roundtrip for family_members check — Phase 1.4 will optimize by caching family_id in a custom cookie or JWT claim
- Kept onboarding paths family-check exempt so users can create their family after registering without getting redirect-looped
- OAuth callback supports optional `next` query param for deep-link redirects (e.g., user was going to /settings before being asked to log in)
- Google OAuth requires external configuration (Supabase Dashboard + Google Cloud Console) — documented as Phase 1.2 user setup task

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None — TypeScript compilation clean with 0 errors. All files created as specified.

## User Setup Required
None for this plan. Google OAuth configuration (Supabase Dashboard Site URL + Redirect URLs, Google Cloud Console OAuth app) is a Phase 1.2 user setup task.

## Next Phase Readiness
- Phase 1.1 complete: SQL migrations, Supabase clients, and auth middleware all in place
- Phase 1.2 (Onboarding Flow) can now build the real login/register/onboarding UI on top of these stubs
- Note: existing app pages (/dashboard, /wallet, etc.) will now redirect unauthenticated users to /login — dev testing with real Supabase env vars is required

---
*Phase: 01.1-db-schema*
*Completed: 2026-03-01*
