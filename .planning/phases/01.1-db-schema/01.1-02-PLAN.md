---
phase: 01.1-db-schema
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/supabase/client.ts
  - lib/supabase/server.ts
  - lib/supabase/middleware.ts
autonomous: true
requirements:
  - REQ-AUTH-005

must_haves:
  truths:
    - "Browser Supabase client uses createBrowserClient from @supabase/ssr"
    - "Server Supabase client uses createServerClient with cookie store (Next.js App Router compatible)"
    - "A middleware utility creates a cookie-syncing Supabase client for use in middleware.ts"
    - "Old lib/supabase.ts is preserved for backward compat but marked as deprecated"
    - "@supabase/ssr package is installed"
  artifacts:
    - path: "lib/supabase/client.ts"
      provides: "Browser client factory for 'use client' components"
      exports: ["createClient"]
    - path: "lib/supabase/server.ts"
      provides: "Server client factory for Server Components and Route Handlers"
      exports: ["createClient"]
    - path: "lib/supabase/middleware.ts"
      provides: "Middleware client factory with cookie sync"
      exports: ["createClient", "updateSession"]
  key_links:
    - from: "lib/supabase/client.ts"
      to: "@supabase/ssr"
      via: "createBrowserClient import"
      pattern: "createBrowserClient"
    - from: "lib/supabase/server.ts"
      to: "next/headers cookies()"
      via: "cookie store for session persistence"
      pattern: "cookies\\(\\)"
---

<objective>
Install @supabase/ssr and create three Supabase client factories that work correctly in the Next.js 14 App Router environment.

Purpose: The current lib/supabase.ts exports a single anonymous client that has no cookie storage — it cannot read auth sessions in Server Components or middleware. This is a prerequisite for middleware.ts (Plan 02 wave 2) and all future authenticated pages.
Output: Three files in lib/supabase/ providing browser, server, and middleware clients.
</objective>

<execution_context>
@/Users/andrei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andrei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01.1-db-schema/01.1-RESEARCH.md

<interfaces>
<!-- Current supabase client (lib/supabase.ts) -->
```typescript
import { createClient } from '@supabase/supabase-js'
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
export const supabase = createClient(supabaseUrl, supabaseAnonKey)
```
This is the OLD pattern. It remains unchanged (do not delete it) but is deprecated.
All NEW authenticated code uses the three new client factories.

<!-- Environment variables available -->
NEXT_PUBLIC_SUPABASE_URL — the Supabase project URL
NEXT_PUBLIC_SUPABASE_ANON_KEY — the anon/public API key
(Both already in .env.local, no new env vars needed for this plan)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @supabase/ssr and create lib/supabase/client.ts</name>
  <files>lib/supabase/client.ts</files>
  <action>
First, install the required package:
```bash
cd /Users/andrei/Desktop/kids-motivation && npm install @supabase/ssr
```

Then create `lib/supabase/client.ts`. This file provides the browser Supabase client for use in `'use client'` components. It must use `createBrowserClient` from `@supabase/ssr` (NOT from `@supabase/supabase-js`). The browser client automatically handles cookie-based session storage.

```typescript
// lib/supabase/client.ts
// Browser Supabase client — use in 'use client' components only.
// For Server Components and Route Handlers, use lib/supabase/server.ts
// For middleware.ts, use lib/supabase/middleware.ts

import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
```

That is the complete file. No default export — named export only to match @supabase/ssr conventions.
  </action>
  <verify>
    <automated>cd /Users/andrei/Desktop/kids-motivation && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>@supabase/ssr is installed (check: node_modules/@supabase/ssr exists). lib/supabase/client.ts exists with createBrowserClient import. TypeScript compilation passes.</done>
</task>

<task type="auto">
  <name>Task 2: Create lib/supabase/server.ts and lib/supabase/middleware.ts</name>
  <files>lib/supabase/server.ts, lib/supabase/middleware.ts</files>
  <action>
Create two more files:

**lib/supabase/server.ts** — for Server Components, Route Handlers, and Server Actions. Uses `createServerClient` with the Next.js `cookies()` API. Must be `async` because `cookies()` is async in Next.js 14+.

```typescript
// lib/supabase/server.ts
// Server Supabase client — use in Server Components, Route Handlers, Server Actions.
// Do NOT import this in 'use client' components.
// For browser components, use lib/supabase/client.ts

import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function createClient() {
  const cookieStore = await cookies()

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // setAll called from a Server Component — read-only cookies are fine
            // The middleware handles cookie refresh
          }
        },
      },
    }
  )
}
```

**lib/supabase/middleware.ts** — for use ONLY inside `middleware.ts` (root level). The middleware client must sync cookies between the incoming request and outgoing response. It also exports `updateSession` which refreshes the auth token and syncs cookies.

```typescript
// lib/supabase/middleware.ts
// Middleware Supabase client — use ONLY inside root middleware.ts.
// This client handles cookie syncing between request/response.

import { createServerClient } from '@supabase/ssr'
import { type NextRequest, NextResponse } from 'next/server'

export async function updateSession(request: NextRequest) {
  let supabaseResponse = NextResponse.next({ request })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value }) =>
            request.cookies.set(name, value)
          )
          supabaseResponse = NextResponse.next({ request })
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options)
          )
        },
      },
    }
  )

  // CRITICAL: use getUser() not getSession() — getSession() does not re-validate JWT
  const {
    data: { user },
  } = await supabase.auth.getUser()

  return { supabase, supabaseResponse, user }
}
```

Note: lib/supabase/middleware.ts exports `updateSession` (not `createClient`) because middleware always needs both the client and the response reference together.
  </action>
  <verify>
    <automated>cd /Users/andrei/Desktop/kids-motivation && npx tsc --noEmit 2>&1 | head -20 && echo "TSC OK"</automated>
  </verify>
  <done>lib/supabase/server.ts exists with async createClient() using createServerClient + cookies(). lib/supabase/middleware.ts exists with updateSession() that returns {supabase, supabaseResponse, user}. TypeScript compilation passes (or only pre-existing errors remain).</done>
</task>

</tasks>

<verification>
```bash
# All three files exist
ls /Users/andrei/Desktop/kids-motivation/lib/supabase/

# @supabase/ssr is installed
ls /Users/andrei/Desktop/kids-motivation/node_modules/@supabase/ssr/package.json

# TypeScript compiles
cd /Users/andrei/Desktop/kids-motivation && npx tsc --noEmit 2>&1 | grep -c "error TS" || echo "0 errors"

# Check exports
grep "export" lib/supabase/client.ts lib/supabase/server.ts lib/supabase/middleware.ts
```
</verification>

<success_criteria>
1. node_modules/@supabase/ssr exists (npm install succeeded)
2. lib/supabase/client.ts — exports createClient() using createBrowserClient
3. lib/supabase/server.ts — exports async createClient() using createServerClient + cookies()
4. lib/supabase/middleware.ts — exports updateSession() using createServerClient with request/response cookie sync
5. TypeScript compilation passes (no new errors introduced)
6. Old lib/supabase.ts unchanged (backward compat for existing code)
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-db-schema/01.1-02-SUMMARY.md` with:
- Package installed: @supabase/ssr
- Files created: lib/supabase/client.ts, lib/supabase/server.ts, lib/supabase/middleware.ts
- Usage contract: client.ts for 'use client', server.ts for Server Components/Route Handlers, middleware.ts for root middleware.ts only
- Old lib/supabase.ts: kept as-is for backward compat; existing pages still import it and still work
</output>
