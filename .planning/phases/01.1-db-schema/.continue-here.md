---
phase: 01.1-db-schema
task: 0
total_tasks: 3
status: ready_to_execute
last_updated: 2026-03-01T13:08:27.140Z
---

<current_state>
Phase 1.1 planning is 100% COMPLETE. All 3 plans are written, verified, and ready to execute.
We have NOT started execution yet. Next step is /gsd:execute-phase 1.1
</current_state>

<completed_work>

## This session — full planning pipeline completed:

- ✅ Analysed existing codebase (28 tables, all hardcoded 'adam'/'alim', no auth)
- ✅ Created full .planning/ structure: PROJECT.md, REQUIREMENTS.md (108 reqs), ROADMAP.md, STATE.md, ARCHITECTURE.md, ONBOARDING.md, CODEBASE-ANALYSIS.md
- ✅ Restructured phase dirs to GSD flat format (01.1-db-schema, 01.2-onboarding, etc.)
- ✅ Reformatted ROADMAP.md to GSD-compatible format (### Phase X.X: Name + Goal + Success Criteria)
- ✅ 01.1-RESEARCH.md — researcher agent produced detailed findings
- ✅ 01.1-01-PLAN.md — SQL migrations (schema-v3.sql, seed-migration.sql, rls.sql)
- ✅ 01.1-02-PLAN.md — Supabase client factories (@supabase/ssr)
- ✅ 01.1-03-PLAN.md — middleware.ts + auth callback route
- ✅ Plan checker ran, found 1 blocker (wrong req IDs in Plan 03), planner revised, re-check PASSED
</completed_work>

<remaining_work>

## Phase 1.1 execution — 3 plans, 2 waves:

**Wave 1 (parallel):**
- Plan 01: Create supabase/schema-v3.sql, supabase/seed-migration.sql, supabase/rls.sql
- Plan 02: npm install @supabase/ssr, create lib/supabase/client.ts, server.ts, middleware.ts

**Wave 2 (after Wave 1):**
- Plan 03: Create middleware.ts (root), app/auth/callback/route.ts, stub pages for /login and /onboarding/welcome
</remaining_work>

<decisions_made>

- **child_id TEXT NOT dropped** — all existing TS code still uses 'adam'/'alim'. Only add new family_id UUID column. Phase 1.4 removes hardcodes.
- **exercise_types gets nullable family_id** — NULL = global default, non-null = family override
- **Bootstrap family 'LEGACY'** — existing adam/alim data migrated to a bootstrap family. Developer creates real Supabase Auth users manually after running SQL.
- **@supabase/ssr** (not deprecated @supabase/auth-helpers-nextjs)
- **getUser() not getSession()** in middleware — security requirement from Supabase docs
- **REQ-AUTH-001/002/004/006** moved to Phase 1.2 — Phase 1.1 only creates auth infrastructure, actual login/register UI is Phase 1.2
- **Middleware family_members performance** — 50ms roundtrip accepted for Phase 1.1, optimization deferred to Phase 1.4 (cache family_id in cookie/JWT)
- **RLS policy pattern** — uses `(SELECT auth.uid())` wrapper (not bare `auth.uid()`) for 20x+ speedup
</decisions_made>

<blockers>
None. Plans verified and clean.

**Note for execution:** The SQL files (Plans 01) are created locally but must be manually pasted into Supabase SQL Editor in order: schema-v3.sql → seed-migration.sql → rls.sql. This is a manual step, not automated.
</blockers>

<context>
We are rebuilding the kids-motivation app (Next.js 14 + Supabase) from a single-family hardcoded app into a universal multi-tenant product for 5,000+ families.

Phase 1.1 is the DB foundation: new families/family_members/user_profiles tables + RLS so each family's data is isolated. The existing adam/alim data is preserved via a bootstrap family migration.

The project has 7 milestones total:
- M1: Foundation (auth + multi-tenant) ← WE ARE HERE
- M2: Core Loop (coins, wallet, shop — 60% already done)
- M3: Communication (chat, notifications)
- M4: PWA Polish ← first release to community of 5,000 parents
- M5: Monetization (Stripe)
- M6: Social (family-to-family)
- M7: Native Apps (App Store, Google Play)
</context>

<next_action>
Start fresh context, then run: /gsd:execute-phase 1.1

This will execute all 3 plans:
- Wave 1: Plans 01+02 in parallel (SQL files + Supabase client factories)
- Wave 2: Plan 03 (middleware.ts + auth callback)

After execution, manually apply SQL to Supabase Dashboard in order:
1. supabase/schema-v3.sql
2. supabase/seed-migration.sql
3. supabase/rls.sql
</next_action>
