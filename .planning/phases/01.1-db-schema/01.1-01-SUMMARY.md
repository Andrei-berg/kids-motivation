---
phase: 01.1-db-schema
plan: "01"
subsystem: database

tags: [supabase, postgresql, rls, row-level-security, multi-tenant, auth-trigger, uuid, families]

# Dependency graph
requires: []

provides:
  - "supabase/schema-v3.sql: user_profiles, families, family_members tables + auth trigger"
  - "supabase/seed-migration.sql: family_id column on all 31 existing tables + bootstrap backfill"
  - "supabase/rls.sql: authenticated family-scoped RLS policies on all 34 tables"

affects:
  - "01.1-02"
  - "01.1-03"
  - "01.2-onboarding"
  - "01.4-dashboard-refactor"
  - "all phases that query data tables"

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "family_isolation RLS policy pattern using (SELECT auth.uid()) wrapper to avoid per-row reevaluation"
    - "Bootstrap family with LEGACY invite code for migrating existing single-tenant data"
    - "SECURITY DEFINER + empty search_path on auth trigger to prevent injection"
    - "ON CONFLICT (id) DO NOTHING in auth trigger to allow idempotent re-runs"
    - "nullable family_id for exercise_types (NULL = global default, non-null = family override)"

key-files:
  created:
    - supabase/schema-v3.sql
    - supabase/seed-migration.sql
    - supabase/rls.sql
  modified: []

key-decisions:
  - "family_id remains nullable until Phase 1.4 removes hardcodes — NOT NULL would break existing TypeScript"
  - "child_id TEXT column is kept on all tables — removed in Phase 1.4 only after hardcodes eliminated"
  - "exercise_types uses nullable family_id: NULL = global default accessible to all, non-null = family override"
  - "Bootstrap family uses invite_code = 'LEGACY' (uppercase, 6 chars) so ON CONFLICT can find it on re-run"
  - "Execution order critical: schema-v3.sql first, then seed-migration.sql, then rls.sql"
  - "Auth trigger uses EXCEPTION block so trigger errors never block user signup"

patterns-established:
  - "family_isolation: standard FOR ALL TO authenticated policy checking family_id IN (SELECT family_id FROM family_members WHERE user_id = (SELECT auth.uid()))"
  - "Index pattern: every family_id column gets an index (idx_{table}_family_id) for RLS performance"
  - "Idempotent migrations: all ALTER TABLE use IF NOT EXISTS, all CREATE INDEX use IF NOT EXISTS"

requirements-completed:
  - REQ-FAM-001
  - REQ-FAM-002
  - REQ-FAM-003
  - REQ-FAM-004
  - REQ-FAM-005
  - REQ-FAM-007
  - REQ-FAM-013
  - REQ-SEC-001
  - REQ-SEC-005

# Metrics
duration: 3min
completed: 2026-03-01
---

# Phase 1.1 Plan 01: DB Schema — Multi-tenant Tables and RLS Summary

**Three SQL migration files implementing multi-tenant Supabase architecture: new identity tables (user_profiles/families/family_members), family_id column on all 31 existing tables, and authenticated family-scoped RLS policies across all 34 tables**

## Performance

- **Duration:** 3 min
- **Started:** 2026-03-01T15:05:27Z
- **Completed:** 2026-03-01T15:08:47Z
- **Tasks:** 3
- **Files modified:** 3 (all created)

## Accomplishments

- Created multi-tenant identity schema: user_profiles (auto-created via auth trigger), families (with unique 6-char invite code), family_members (role-based: parent/child/extended)
- Added family_id UUID column (nullable, FK to families) to all 31 existing tables with performance indexes — safe to re-run via IF NOT EXISTS
- Replaced public-access policies with authenticated family-scoped RLS on all 34 tables — data isolation is deny-all by default, permit-by-family-membership

## Task Commits

Each task was committed atomically:

1. **Task 1: Create supabase/schema-v3.sql** - `ced902d` (feat)
2. **Task 2: Create supabase/seed-migration.sql** - `28eeff6` (feat)
3. **Task 3: Create supabase/rls.sql** - `df9271d` (feat)

**Plan metadata:** (docs commit follows)

## Files Created/Modified

- `supabase/schema-v3.sql` - New identity tables (user_profiles, families, family_members) + auth trigger with EXCEPTION block
- `supabase/seed-migration.sql` - Adds family_id to all 31 existing tables + bootstrap backfill for adam/alim data
- `supabase/rls.sql` - Drops all public policies, enables RLS, installs family_isolation policies on all 34 tables

## Decisions Made

- **family_id stays nullable until Phase 1.4:** Adding NOT NULL now would break all existing TypeScript inserts that don't supply family_id. Made nullable so existing code continues working during migration.
- **child_id TEXT is NOT removed:** All existing lib/api.ts, lib/wallet-api.ts etc. reference `child_id = 'adam'/'alim'`. Only Phase 1.4 removes these hardcodes.
- **exercise_types nullable family_id:** NULL = global default exercise type visible to all authenticated users; non-null = family-specific override. Unique constraint needed in future if family overrides conflict with globals.
- **Bootstrap family with LEGACY invite code:** Using a known fixed invite_code enables idempotent re-runs via ON CONFLICT. The bootstrap family_id is printed in RAISE NOTICE — developer must save it manually.
- **Auth trigger safety pattern:** SECURITY DEFINER + `SET search_path = ''` + EXCEPTION block ensures (a) trigger has elevated privilege to insert into user_profiles, (b) search_path injection is impossible, (c) any unexpected error never blocks user signup.
- **RLS policy performance:** `(SELECT auth.uid())` wrapper vs bare `auth.uid()` avoids PostgreSQL re-evaluating the function for every row in a table scan — critical for tables with thousands of rows.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

After running these SQL files in Supabase SQL Editor (in order: schema-v3.sql → seed-migration.sql → rls.sql):

1. **Save the bootstrap family_id** from the RAISE NOTICE output of seed-migration.sql
2. **Create auth users for Adam and Alim** in Supabase Dashboard → Authentication → Users
3. **Run the INSERT snippet** in seed-migration.sql (commented out at the bottom) to link the real auth users to the bootstrap family
4. **Optionally add a parent auth user** to family_members with role = 'parent'

Until Step 3 is done, Adam/Alim's data will be invisible (RLS deny-all — no family_members rows match their auth UIDs).

## Next Phase Readiness

- SQL schema foundation is complete — Phase 01.1-02 (Supabase clients) and 01.1-03 (middleware) can proceed
- TypeScript build is unaffected (no TS changes in this plan)
- Existing app continues working as-is until RLS is applied in Supabase (SQL files are inert until run)

---
*Phase: 01.1-db-schema*
*Completed: 2026-03-01*

## Self-Check: PASSED

- supabase/schema-v3.sql: FOUND
- supabase/seed-migration.sql: FOUND
- supabase/rls.sql: FOUND
- .planning/phases/01.1-db-schema/01.1-01-SUMMARY.md: FOUND
- Commit ced902d: FOUND
- Commit 28eeff6: FOUND
- Commit df9271d: FOUND
