---
phase: 01.2-onboarding
plan: "05"
subsystem: ui
tags: [nextjs, supabase, typescript, onboarding, auth, rls]

# Dependency graph
requires:
  - phase: 01.2-01
    provides: "lib/onboarding-api.ts — lookupFamilyByCode, joinFamilyAsChild, ChildProfile type, getFamilyChildren function"
  - phase: 01.1-03
    provides: "middleware.ts — auth + family membership check with redirect logic"
provides:
  - "app/onboarding/join/page.tsx — 3-scenario join flow: child claim pre-created profile, adult join as parent/extended-family, already-member guard"
  - "lib/onboarding-api.ts — getFamilyChildren (unlinked children only), join_family_as_adult, claim_child_profile RPC support"
  - "middleware.ts — no-family redirect updated to /onboarding (not /onboarding/welcome)"
affects: [01.3, 01.4, dashboard]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "2-screen state machine with 'code' | 'confirm' discriminated union for simple flows"
    - "SECURITY DEFINER RPC (claim_child_profile) for idempotent membership row claims"
    - "Role-selection flow: join page handles both child (claim profile) and adult (parent/extended) join paths"
    - "getFamilyChildren filters user_id IS NULL to show only unclaimed child profiles"

key-files:
  created:
    - app/onboarding/join/page.tsx
  modified:
    - middleware.ts
    - lib/onboarding-api.ts

key-decisions:
  - "claim_child_profile SECURITY DEFINER RPC handles duplicate membership gracefully — upsert at DB level avoids duplicate rows race condition"
  - "getFamilyChildren only returns unlinked children (user_id IS NULL) — already-claimed profiles are hidden so two users cannot claim same profile"
  - "join_family_as_adult added to handle adults joining as parent or extended family (grandparent etc.) — not in original plan, added during testing"
  - "Already-member guard: if user already has membership, join page shows message + link to dashboard instead of re-joining"
  - "onboarding_step redirect removed from join page — join is always intentional navigation, not an onboarding gate"

patterns-established:
  - "Pattern: 2-screen code-entry flows use screen: 'code' | 'confirm' state, no URL changes"
  - "Pattern: onboarding pages match wizard visual language (white card, emerald-500, inline styles)"
  - "Pattern: SECURITY DEFINER RPCs for operations that need to bypass RLS row-level conflicts"

requirements-completed:
  - REQ-ONB-009
  - REQ-FAM-003
  - REQ-FAM-008
  - REQ-FAM-009
  - REQ-AUTH-008

# Metrics
duration: 60min
completed: 2026-03-02
---

# Phase 1.2 Plan 05: Child Join Flow Summary

**6-digit invite code entry at /onboarding/join handles 3 scenarios: child claiming pre-registered profile, adult joining as parent/extended family, and already-member guard — with SECURITY DEFINER RPC for idempotent profile claiming**

## Performance

- **Duration:** ~60 min (includes testing, schema fixes, and scope expansion)
- **Started:** 2026-03-01T21:00:00Z
- **Completed:** 2026-03-02T01:03:00Z
- **Tasks:** 3 of 3 complete (2 auto + 1 checkpoint:human-verify — approved)
- **Files modified:** 3 code files + Supabase schema RPC

## Accomplishments
- Updated `middleware.ts` redirect target from `/onboarding/welcome` to `/onboarding`
- Added `ChildProfile` interface and `getFamilyChildren` (unlinked-only) to `lib/onboarding-api.ts`
- Created `app/onboarding/join/page.tsx` — 3-scenario join flow covering child profile claim, adult role join, and already-member protection
- Added `join_family_as_adult()` API function for parents and extended family joining via invite code
- Created `claim_child_profile` SECURITY DEFINER RPC in Supabase to handle duplicate membership row conflicts gracefully

## Task Commits

Each task was committed atomically:

1. **Task 1: Update middleware.ts + add getFamilyChildren** - `f462c02` (feat)
2. **Task 2: Create /onboarding/join page** - `fc72a20` (feat)
3. **Task 3 post-checkpoint fixes (during human testing):**
   - `884f6f5` — fix: claim child profile via UPDATE by id to prevent duplicate rows
   - `cbf1cd4` — fix: use claim_child_profile RPC for graceful duplicate membership handling
   - `5811332` — feat: full join flow — child claim, adult role selection, already-member guard
   - `c89bdd1` — fix: remove onboarding_step redirect from join page

**Plan metadata:** `ca4cf96` (docs: complete plan — pre-checkpoint SUMMARY + STATE + ROADMAP)

## Files Created/Modified
- `middleware.ts` — Changed redirect from `/onboarding/welcome` to `/onboarding` for no-family authenticated users
- `lib/onboarding-api.ts` — Added `ChildProfile` interface, `getFamilyChildren(familyId)` (filters user_id IS NULL), `join_family_as_adult()` for adult members, `claim_child_profile` RPC call support
- `app/onboarding/join/page.tsx` — 3-scenario join flow: Screen 1 (6-char uppercase code entry, lookup), Screen 2 (role decision: child picks profile card → claims with RPC; adult selects role → joins as parent/extended family; already-member shows dashboard link)

## Decisions Made
- `claim_child_profile` SECURITY DEFINER RPC handles upsert at DB level — prevents duplicate family_members rows when multiple claims race or retry
- `getFamilyChildren` returns only unlinked profiles (`user_id IS NULL`) — claimed profiles are hidden so one auth account = one child profile
- `join_family_as_adult()` added during testing to cover grandparents and other adult household members joining via invite code
- Already-member guard added: page detects existing membership on load and shows a "you're already in" message with /dashboard link
- `onboarding_step` redirect logic removed from join page — the page is reachable at any time, not only during first onboarding

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Duplicate row on child profile claim**
- **Found during:** Task 3 (human verification testing)
- **Issue:** Upsert with `onConflict: family_id,user_id` created duplicate rows when a child with user_id NULL tried to claim their profile — constraint didn't match existing null-user_id row
- **Fix:** Switched from upsert to UPDATE by member id (`claim_child_profile` RPC updates existing row to set `user_id = auth.uid()`)
- **Files modified:** `lib/onboarding-api.ts`, `app/onboarding/join/page.tsx`
- **Committed in:** `884f6f5`, then `cbf1cd4`

**2. [Rule 2 - Missing Critical] Added adult join path**
- **Found during:** Task 3 (human verification testing)
- **Issue:** Original plan only handled child claiming a pre-registered profile. Adult family members (parents re-joining on new device, grandparents) had no path to join via invite code
- **Fix:** Added role-selection UI on Screen 2 (Is this a child profile or are you an adult?) + `join_family_as_adult()` API function that inserts family_members with parent/extended_family role
- **Files modified:** `lib/onboarding-api.ts`, `app/onboarding/join/page.tsx`
- **Committed in:** `5811332`

**3. [Rule 2 - Missing Critical] Already-member guard**
- **Found during:** Task 3 (human verification testing)
- **Issue:** No protection if a user who already belongs to the family navigated to /onboarding/join — they would see the code entry screen and potentially create a second membership row
- **Fix:** Page checks for existing membership on load; if found, shows "Вы уже в семье" message with link to /dashboard instead of the code entry screen
- **Files modified:** `app/onboarding/join/page.tsx`
- **Committed in:** `5811332`

**4. [Rule 1 - Bug] Removed onboarding_step redirect from join page**
- **Found during:** Task 3 (human verification testing)
- **Issue:** Join page was checking onboarding_step and redirecting mid-flow, which broke adults joining since they have no wizard step context
- **Fix:** Removed the onboarding_step check — join is always intentional navigation
- **Files modified:** `app/onboarding/join/page.tsx`
- **Committed in:** `c89bdd1`

---

**Total deviations:** 4 auto-fixed (2 bugs, 2 missing critical)
**Impact on plan:** All fixes necessary for correctness and real-world usage. Scope expanded to include adults joining family and already-member protection — both essential for production use.

## Issues Encountered
- RLS/schema issues required Supabase Dashboard fixes during testing: `family_members.user_id` needed to be nullable (done in Plan 04), `families.created_by` needed to exist for post-INSERT visibility, and the recursive RLS policy on `family_members` caused stack overflow — resolved with SECURITY DEFINER helper `get_my_family_ids()` (from Plan 04 fixes, carried forward here).

## User Setup Required
None — no new external service configuration required. The `claim_child_profile` RPC must exist in Supabase (applied during testing session).

## Next Phase Readiness
- Phase 1.2 complete — all 5 plans done: data foundation, auth pages, parent wizard (steps 0-4), parent wizard (steps 5-6), child join flow
- Phase 1.3 (flexible categories + schedule) can begin
- The join flow covers all realistic entry scenarios: children claim profiles, adults join with role selection, duplicate membership is protected

## Self-Check: PASSED

- FOUND: app/onboarding/join/page.tsx
- FOUND: lib/onboarding-api.ts
- FOUND: .planning/phases/01.2-onboarding/01.2-05-SUMMARY.md
- FOUND commit: f462c02 (Task 1)
- FOUND commit: fc72a20 (Task 2)
- FOUND commit: 5811332 (post-checkpoint expansion)
- FOUND commit: c89bdd1 (post-checkpoint fix)

---
*Phase: 01.2-onboarding*
*Completed: 2026-03-02*
