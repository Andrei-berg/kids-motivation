---
phase: 01.2-onboarding
plan: "05"
subsystem: ui
tags: [nextjs, supabase, typescript, onboarding, auth]

# Dependency graph
requires:
  - phase: 01.2-01
    provides: "lib/onboarding-api.ts — lookupFamilyByCode, joinFamilyAsChild, ChildProfile type, getFamilyChildren function"
  - phase: 01.1-03
    provides: "middleware.ts — auth + family membership check with redirect logic"
provides:
  - "app/onboarding/join/page.tsx — 2-screen child join flow: code entry → profile confirm → /dashboard"
  - "lib/onboarding-api.ts — getFamilyChildren function + ChildProfile interface added"
  - "middleware.ts — no-family redirect updated to /onboarding (not /onboarding/welcome)"
affects: [01.3, 01.4, dashboard]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "2-screen state machine with 'code' | 'confirm' discriminated union for simple flows"
    - "inline style conventions from wizard page — matching visual language without shared style files"
    - "supabase.auth.getUser() called at join time (not earlier) to avoid stale auth state issues"

key-files:
  created:
    - app/onboarding/join/page.tsx
  modified:
    - middleware.ts
    - lib/onboarding-api.ts

key-decisions:
  - "joinFamilyAsChild updates existing null-user_id row via upsert (onConflict: family_id,user_id) — child picks their pre-created profile and links their auth UID to it"
  - "Empty children list shows helpful message (parent hasn't added children yet) rather than blocking error — graceful degradation"
  - "Avatar display: if avatar_url doesn't start with 'http' it is treated as emoji — same logic parent wizard uses when storing emoji avatars"

patterns-established:
  - "Pattern: 2-screen code-entry flows use screen: 'code' | 'confirm' state, no URL changes"
  - "Pattern: onboarding pages match wizard visual language (white card, emerald-500, inline styles)"

requirements-completed:
  - REQ-ONB-009
  - REQ-FAM-003
  - REQ-FAM-008
  - REQ-FAM-009
  - REQ-AUTH-008

# Metrics
duration: 10min
completed: 2026-03-01
---

# Phase 1.2 Plan 05: Child Join Flow Summary

**6-digit invite code entry + family profile picker at /onboarding/join, with middleware redirect corrected from /onboarding/welcome to /onboarding**

## Performance

- **Duration:** ~10 min
- **Started:** 2026-03-01T21:00:00Z
- **Completed:** 2026-03-01T21:11:12Z
- **Tasks:** 2 of 2 auto tasks complete (checkpoint:human-verify pending user testing)
- **Files modified:** 3

## Accomplishments
- Updated `middleware.ts` redirect target from `/onboarding/welcome` to `/onboarding` — the wizard page now handles routing itself
- Added `ChildProfile` interface and `getFamilyChildren` function to `lib/onboarding-api.ts`
- Created `app/onboarding/join/page.tsx` (461 lines) — 2-screen flow: code entry → profile confirm → `/dashboard`

## Task Commits

Each task was committed atomically:

1. **Task 1: Update middleware.ts + add getFamilyChildren** - `f462c02` (feat)
2. **Task 2: Create /onboarding/join page** - `fc72a20` (feat)

## Files Created/Modified
- `middleware.ts` — Changed redirect from `/onboarding/welcome` to `/onboarding` for no-family authenticated users
- `lib/onboarding-api.ts` — Added `ChildProfile` interface + `getFamilyChildren(familyId)` function that fetches all child family_members for the join flow
- `app/onboarding/join/page.tsx` — 2-screen child join flow: Screen 1 (code entry with 6-char uppercase input, inline error for invalid codes, calls `lookupFamilyByCode`), Screen 2 (family name heading + selectable child profile cards with emoji/photo avatars, "Это я!" button calls `joinFamilyAsChild` → `/dashboard`)

## Decisions Made
- Avatar display: if `avatar_url` doesn't start with `http` it is treated as an emoji string — consistent with how the wizard stores emoji avatars (`avatarUrl = selectedEmoji`)
- Empty children list shows a helpful Russian-language message rather than disabling the flow entirely — allows child to still tell parent to add them
- `supabase.auth.getUser()` is called at join confirmation time (not on page load) — avoids stale auth state issues and keeps the flow lightweight

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None.

## User Setup Required
None — no external service configuration required. The child join flow is ready to test once the dev server is running.

## Next Phase Readiness
- Phase 1.2 complete — all 5 plans done: data foundation, auth pages, parent wizard (steps 0-4), parent wizard (steps 5-6), child join flow
- Phase 1.3 (flexible categories + schedule) can begin
- The middleware redirect fix means `/onboarding` correctly handles both parent (new wizard) and child (via /onboarding/join link or direct nav) routing

## Self-Check: PASSED

- FOUND: app/onboarding/join/page.tsx
- FOUND: lib/onboarding-api.ts
- FOUND: .planning/phases/01.2-onboarding/01.2-05-SUMMARY.md
- FOUND commit: f462c02 (Task 1)
- FOUND commit: fc72a20 (Task 2)

---
*Phase: 01.2-onboarding*
*Completed: 2026-03-01*
