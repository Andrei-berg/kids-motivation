---
phase: 01.2-onboarding
plan: "04"
type: execute
wave: 3
depends_on:
  - "01.2-03"
files_modified:
  - app/onboarding/page.tsx
autonomous: false
requirements:
  - REQ-ONB-007
  - REQ-ONB-008
  - REQ-ONB-010
  - REQ-FAM-010

must_haves:
  truths:
    - "Step 6 (Categories): parent selects from 4 preset categories with toggle buttons"
    - "Step 7 (Done): confetti burst fires, success message shows, app navigates to /dashboard after 3s"
    - "Selected categories are stored to families table (default_categories column or family settings)"
    - "Wizard is fully functional end-to-end from step 0 to /dashboard"
  artifacts:
    - path: "app/onboarding/page.tsx"
      provides: "Complete 7-step wizard including steps 5-6 and confetti"
    - path: "supabase/onboarding-patch.sql"
      provides: "May need update if default_categories column needed ‚Äî check schema"
  key_links:
    - from: "app/onboarding/page.tsx (Step 5)"
      to: "families table"
      via: "lib/onboarding-api.ts saveCategories or direct supabase update"
      pattern: "categories|default_categories"
    - from: "app/onboarding/page.tsx (Step 6)"
      to: "/dashboard"
      via: "router.push('/dashboard') after confetti delay"
      pattern: "router\\.push.*dashboard"
---

<objective>
Complete the onboarding wizard with steps 6-7: category selection and the Done/confetti screen. Replace the placeholder added in Plan 03. After Done, parent lands on /dashboard ‚Äî fully onboarded.

Purpose: The wizard must reach a real finish line. Confetti is the one moment of delight in an otherwise clean UI.
Output: Complete end-to-end onboarding wizard from welcome screen to dashboard.
</objective>

<execution_context>
@/Users/andrei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andrei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01.2-onboarding/01.2-CONTEXT.md
@.planning/phases/01.2-onboarding/01.2-03-SUMMARY.md
@.planning/phases/01.2-onboarding/01.2-01-SUMMARY.md

<interfaces>
<!-- From lib/onboarding-api.ts (Plan 01) -->
import { updateOnboardingStep } from '@/lib/onboarding-api'
// updateOnboardingStep(userId: string, step: number): Promise<void>

// New function needed ‚Äî add to lib/onboarding-api.ts:
// saveDefaultCategories(familyId: string, categories: string[]): Promise<void>
//   Upserts into a family_settings table or stores as JSON on families.
//   If no suitable column exists, store in families table as a JSONB column.
//   See schema note below.

<!-- Schema note: -->
// The families table in schema-v3.sql does NOT have a categories column.
// Options for storing selected categories:
// A) Add default_categories JSONB column to families (requires SQL patch addition)
// B) Skip persisting categories in this MVP ‚Äî Phase 1.3 (categories-schedule) will
//    create proper category tables. The wizard step is UI-only in Phase 1.2,
//    and Phase 1.3 will create the real category rows.
//
// DECISION (per CONTEXT.md "Claude's Discretion"): Use option B.
// Show the category toggle UI (REQ-ONB-007), but store nothing to DB in Phase 1.2.
// Phase 1.3 will read these preferences and create the actual category records.
// Document this in SUMMARY.md so Phase 1.3 executor knows to handle category seeding.
// The only DB call on step 5 completion: updateOnboardingStep(userId, 6).

<!-- canvas-confetti -->
// Per CONTEXT.md decisions: use canvas-confetti for Done screen only
// Install: npm install canvas-confetti @types/canvas-confetti
// Usage:
import confetti from 'canvas-confetti'
confetti({
  particleCount: 150,
  spread: 80,
  origin: { y: 0.6 },
  colors: ['#10b981', '#059669', '#f59e0b', '#3b82f6']
})
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install canvas-confetti and add Steps 5-6 to onboarding wizard</name>
  <files>app/onboarding/page.tsx</files>
  <action>
First install canvas-confetti: `npm install canvas-confetti @types/canvas-confetti`

Then update app/onboarding/page.tsx to replace the steps 5-6 placeholder with real implementations:

**Step 5 ‚Äî Categories:**
- Heading: "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π"
- Subheading: "–í—ã —Å–º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö"
- 4 toggle cards (2√ó2 grid on mobile), each with emoji + name + description:
  - üìö "–£—á—ë–±–∞" ‚Äî "–û—Ü–µ–Ω–∫–∏, –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è"
  - üè† "–î–æ–º" ‚Äî "–£–±–æ—Ä–∫–∞ –∫–æ–º–Ω–∞—Ç—ã, –ø–æ–º–æ—â—å –ø–æ –¥–æ–º—É"
  - ‚öΩ "–°–ø–æ—Ä—Ç" ‚Äî "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, —Å–µ–∫—Ü–∏–∏, —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è"
  - ‚è∞ "–†–∞—Å–ø–æ—Ä—è–¥–æ–∫" ‚Äî "–†–µ–∂–∏–º –¥–Ω—è, –ª–∏—á–Ω–∞—è –≥–∏–≥–∏–µ–Ω–∞"
- All 4 toggled ON by default (emerald border + light emerald background when selected, gray border + white when unselected)
- Toggle on click (user can deselect any)
- Note: categories are NOT saved to DB in Phase 1.2 (Phase 1.3 handles this). Only DB call: `updateOnboardingStep(userId, 5)` on step advancement.
- "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" button (always enabled ‚Äî can proceed even with all deselected)

**Step 6 ‚Äî Done:**
- On entering this step: fire confetti immediately
  ```typescript
  useEffect(() => {
    if (currentStep === 6) {
      confetti({
        particleCount: 150,
        spread: 80,
        origin: { y: 0.6 },
        colors: ['#10b981', '#059669', '#f59e0b', '#3b82f6']
      })
    }
  }, [currentStep])
  ```
- Large success emoji: üéâ (text-6xl, text-center)
- Heading: "–í—Å—ë –≥–æ—Ç–æ–≤–æ!" (text-2xl font-bold, text-center)
- Subheading: "–í–∞—à–∞ —Å–µ–º—å—è —Å–æ–∑–¥–∞–Ω–∞. –ü–æ—Ä–∞ –Ω–∞—á–∏–Ω–∞—Ç—å!" (gray-500, text-center)
- Summary card (rounded-xl, bg-gray-50, p-4, mt-4): shows what was created:
  - "üë§ –†–æ–¥–∏—Ç–µ–ª—å: {parentName}"
  - "üè† –°–µ–º—å—è: {familyName}"
  - "üîë –ö–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: {inviteCode}" (with copy button)
- Primary button: "–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" (emerald-500)
- On click (or auto after 5s ‚Äî Claude's discretion, but button click is primary): `updateOnboardingStep(userId, 6)` then `router.push('/dashboard')`
- No Back button on Done screen.

**Import for confetti:** add `import confetti from 'canvas-confetti'` at top of file. Import is dynamic-safe since 'use client' components load in browser.

**Progress bar on step 6:** show "Step 7 of 7" and 100% fill.
  </action>
  <verify>
    <automated>cd /Users/andrei/Desktop/kids-motivation && npm install canvas-confetti @types/canvas-confetti --save 2>&1 | tail -3 && npx tsc --noEmit 2>&1 | grep -E "onboarding|confetti|error TS" | head -20; echo "Done"</automated>
  </verify>
  <done>canvas-confetti installed. Steps 5 (category toggles) and 6 (confetti + done screen) implemented. Wizard reaches /dashboard on completion. TypeScript clean.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Verify complete 7-step wizard end-to-end</name>
  <action>Human verification step: walk through all 7 wizard steps, verify DB rows created, confirm confetti fires and redirect to /dashboard works.</action>
  <what-built>Complete 7-step onboarding wizard from Welcome to Done with confetti burst and redirect to /dashboard</what-built>
  <how-to-verify>
1. Run: `npm run dev`
2. Log in with a test account that has NO family_members row (or create a new test account)
3. You should be redirected to /onboarding/welcome ‚Üí then to /onboarding automatically
4. Walk through all 7 steps:
   - Step 1 (Welcome): verify emoji, description text, "–ù–∞—á–∞—Ç—å" button
   - Step 2 (Profile): enter name, verify it saves (progress bar advances to 2/7)
   - Step 3 (Family): enter family name, verify family created in Supabase Dashboard ‚Üí Table Editor ‚Üí families
   - Step 4 (Add Child): enter child name, pick emoji, enter birth year, verify family_members row created with role='child'
   - Step 5 (Invite): verify invite code displayed, copy button works (paste in text editor to confirm)
   - Step 6 (Categories): verify 4 category cards toggle on/off
   - Step 7 (Done): verify confetti fires, summary card shows parent name + family name + invite code
5. Click "–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" ‚Üí verify redirect to /dashboard
6. Reload /onboarding ‚Üí verify you're sent to /dashboard (onboarding_step = 6, wizard should redirect completed users)
7. Run: `npx tsc --noEmit` ‚Üí 0 errors
  </how-to-verify>
  <resume-signal>Type "approved" once full wizard works end-to-end, or describe any broken steps</resume-signal>
</task>

</tasks>

<verification>
- Step 5: 4 category toggles, all ON by default, "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" advances
- Step 6: confetti fires on enter, summary card shows name/family/code, "–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" ‚Üí /dashboard
- onboarding_step = 6 in user_profiles after completion (verify in Supabase Table Editor)
- Completed users who revisit /onboarding: add a check in useEffect ‚Äî if onboarding_step >= 6 and user has family_members row, redirect to /dashboard immediately
- Progress bar shows 100% on step 7
- TypeScript: `npx tsc --noEmit` passes
</verification>

<success_criteria>
1. Step 5 shows 4 category toggles with correct emoji and copy
2. Step 6 triggers confetti animation
3. Done screen shows family summary with invite code
4. "–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" navigates to /dashboard
5. onboarding_step = 6 in DB after wizard completes
6. Already-onboarded users sent directly to /dashboard if they revisit /onboarding
7. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01.2-onboarding/01.2-04-SUMMARY.md`
</output>
