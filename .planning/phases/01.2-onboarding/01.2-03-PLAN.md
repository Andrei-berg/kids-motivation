---
phase: 01.2-onboarding
plan: "03"
type: execute
wave: 2
depends_on:
  - "01.2-01"
files_modified:
  - app/onboarding/page.tsx
  - app/onboarding/welcome/page.tsx
autonomous: true
requirements:
  - REQ-ONB-001
  - REQ-ONB-002
  - REQ-ONB-003
  - REQ-ONB-004
  - REQ-ONB-005
  - REQ-ONB-006
  - REQ-ONB-010
  - REQ-FAM-001
  - REQ-FAM-009

must_haves:
  truths:
    - "Parent sees a progress bar at the top showing 'Step N of 7'"
    - "Step 1 (Welcome): intro screen with philosophy, Next button"
    - "Step 2 (Profile): parent enters display name, saved to user_profiles"
    - "Step 3 (Family): parent enters family name, family created in DB with invite_code"
    - "Step 4 (Add Child): parent enters child name + birth year + emoji avatar, child added to family_members"
    - "Step 5 (Invite Parent): shows invite code with copy button, has Skip option"
    - "Wizard resumes at correct step if user closes and returns"
    - "Slide transitions: forward = slide left, back = slide right"
  artifacts:
    - path: "app/onboarding/page.tsx"
      provides: "7-step wizard component with React state, step persistence, slide transitions"
      min_lines: 250
    - path: "app/onboarding/welcome/page.tsx"
      provides: "Redirect to /onboarding (middleware sends here, wizard is at /onboarding)"
  key_links:
    - from: "app/onboarding/page.tsx"
      to: "lib/onboarding-api.ts"
      via: "saveParentProfile, createFamily, addChildToFamily, getOnboardingStep"
      pattern: "import.*onboarding-api"
    - from: "app/onboarding/page.tsx"
      to: "lib/supabase/client.ts"
      via: "supabase.auth.getUser() to get current user ID"
      pattern: "getUser|auth\\.user"
---

<objective>
Build the parent onboarding wizard: a single-page 7-step flow at /onboarding. Steps 1-5 in this plan: Welcome, Profile, Family, Add Child, Invite Parent. State managed entirely in React (no sub-routes). Step position persisted in DB via onboarding_step field so users can resume.

Purpose: First experience for every new parent. Must be fast, clear, and complete in under 3 minutes.
Output: Functional 5-step wizard at /onboarding with persistence and slide transitions.
</objective>

<execution_context>
@/Users/andrei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andrei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01.2-onboarding/01.2-CONTEXT.md
@.planning/phases/01.2-onboarding/01.2-01-SUMMARY.md
@app/globals.css

<interfaces>
<!-- From lib/onboarding-api.ts (created in Plan 01) -->
import {
  getOnboardingStep,
  saveParentProfile,
  createFamily,
  addChildToFamily,
  updateOnboardingStep,
} from '@/lib/onboarding-api'

// getOnboardingStep(userId: string): Promise<number>
//   Returns 0-6 (0 = not started, resume to step 0)

// saveParentProfile(userId: string, { displayName: string }): Promise<void>
//   Saves display name, sets onboarding_step = 1

// createFamily(userId: string, { name: string }): Promise<FamilyCreateResult>
//   Returns { familyId: string, inviteCode: string }
//   Sets onboarding_step = 2

// addChildToFamily(
//   familyId: string,
//   { displayName: string, birthYear: number, avatarUrl?: string },
//   parentUserId: string
// ): Promise<ChildMember>
//   Returns { memberId: string, inviteCode: string }
//   Sets onboarding_step = 3

// updateOnboardingStep(userId: string, step: number): Promise<void>

<!-- From lib/supabase/client.ts -->
import { createClient } from '@/lib/supabase/client'
const supabase = createClient()
const { data: { user } } = await supabase.auth.getUser()
// user.id = UUID of current authenticated user

<!-- Design system -->
--emerald-500: #10b981  (primary buttons, progress bar fill, active states)
--gray-200: #e5e7eb     (progress bar track, input borders)
--gray-900: #111827     (headings)
--gray-500: #6b7280     (muted text, subheadings)
--transition-base: 300ms cubic-bezier(0.4, 0, 0.2, 1)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update app/onboarding/welcome/page.tsx ‚Äî redirect to /onboarding</name>
  <files>app/onboarding/welcome/page.tsx</files>
  <action>
The middleware currently redirects no-family users to `/onboarding/welcome`. The wizard lives at `/onboarding`. Make welcome redirect immediately:

```tsx
'use client'
import { useEffect } from 'react'
import { useRouter } from 'next/navigation'

export default function OnboardingWelcomePage() {
  const router = useRouter()
  useEffect(() => {
    router.replace('/onboarding')
  }, [router])
  return null
}
```

This keeps the middleware target valid (/onboarding/welcome) while sending users to the actual wizard page (/onboarding). No loading state needed ‚Äî redirect is instant.
  </action>
  <verify>
    <automated>cd /Users/andrei/Desktop/kids-motivation && npx tsc --noEmit 2>&1 | grep "welcome" | head -5; grep -q "router.replace" app/onboarding/welcome/page.tsx && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>app/onboarding/welcome/page.tsx redirects to /onboarding via router.replace. TypeScript clean.</done>
</task>

<task type="auto">
  <name>Task 2: Create app/onboarding/page.tsx ‚Äî 7-step wizard (steps 1-5 implemented, steps 6-7 placeholder)</name>
  <files>app/onboarding/page.tsx</files>
  <action>
Create the parent onboarding wizard. Single URL /onboarding, step tracked in React state.

**Architecture:**
```tsx
'use client'
// Single component with currentStep: number (0-6), stored in useState
// Transition direction stored in useState<'forward'|'backward'>
// wizardData stored in useState: { userId, familyId, inviteCode, parentName, familyName }
// Loading states per step: submitting boolean
```

**On mount (useEffect):**
1. Call `supabase.auth.getUser()` to get userId
2. Call `getOnboardingStep(userId)` to resume from last step
3. Set currentStep to the returned value

**Layout structure (full page, centered card):**
- White card: max-w-md, mx-auto, min-h-screen or mt-8 on desktop, rounded-2xl, shadow-xl, p-8
- Progress bar at top: small bar (h-2, gray-200 track, emerald-500 fill), with text "Step {current+1} of 7" (text-xs, gray-500, mb-2)
  - Width: `${((currentStep + 1) / 7) * 100}%` ‚Äî animate with transition-all duration-300
- Step content area below: slides with CSS transform translateX
- Back button (gray-500, text-sm) at bottom-left if currentStep > 0
- Primary button at bottom-right

**Slide transition:**
- Use CSS classes. When `direction === 'forward'`: slide incoming step from right (translateX(100%) ‚Üí translateX(0)). When `direction === 'backward'`: from left (translateX(-100%) ‚Üí translateX(0)).
- Simplest implementation: key the step content div by `currentStep` and use a CSS animation class. Define these in globals.css additions or as inline style transitions (Claude's discretion).
- Example approach: maintain a `visible` boolean, on step change set to false (exit), swap content, set to true (enter). Or use CSS `@keyframes slide-in-right`.

**Step 0 ‚Äî Welcome:**
- Large emoji: üåü (text-6xl, text-center)
- Heading: "Welcome to FamilyCoins" (text-2xl font-bold gray-900)
- Subheading: "Motivate your children with a real reward system. Grades, chores, sport ‚Äî all tracked and rewarded." (gray-500, text-sm, text-center, max-w-xs mx-auto)
- 3 short bullet points with emoji icons (Claude's discretion on exact copy, keep in Russian or English ‚Äî use Russian since app is in Russian):
  - "üèÜ –î–µ—Ç–∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –º–æ–Ω–µ—Ç—ã –∑–∞ —É—á—ë–±—É –∏ –¥–æ–º–∞—à–Ω–∏–µ –¥–µ–ª–∞"
  - "üõí –ú–æ–Ω–µ—Ç—ã –æ–±–º–µ–Ω–∏–≤–∞—é—Ç—Å—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã"
  - "üìä –í—ã –≤–∏–¥–∏—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥–æ–≥–æ —Ä–µ–±—ë–Ω–∫–∞"
- Primary button: "–ù–∞—á–∞—Ç—å" (emerald-500 bg, white text, rounded-lg, py-3, full-width)
- On click: setCurrentStep(1), setDirection('forward'). NO DB call on step 0.

**Step 1 ‚Äî Profile:**
- Heading: "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ"
- Subheading: "–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?"
- Single text input: "–í–∞—à–µ –∏–º—è" (placeholder), value = wizardData.parentName
- Primary button: "–î–∞–ª–µ–µ"
- On click: validate name not empty, call `saveParentProfile(userId, { displayName: name })`, advance step

**Step 2 ‚Äî Family:**
- Heading: "–°–æ–∑–¥–∞–π—Ç–µ –≤–∞—à—É —Å–µ–º—å—é"
- Subheading: "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–π —Å–µ–º—å–∏"
- Text input: "–ù–∞–ø—Ä–∏–º–µ—Ä: –°–µ–º—å—è –ò–≤–∞–Ω–æ–≤—ã—Ö" (placeholder), value = wizardData.familyName
- Primary button: "–°–æ–∑–¥–∞—Ç—å —Å–µ–º—å—é"
- On click: call `createFamily(userId, { name })`, store returned { familyId, inviteCode } in wizardData, advance step

**Step 3 ‚Äî Add Child:**
- Heading: "–î–æ–±–∞–≤—å—Ç–µ —Ä–µ–±—ë–Ω–∫–∞"
- Subheading: "–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤–∞—à–µ–≥–æ –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–±—ë–Ω–∫–∞"
- Text input: "–ò–º—è —Ä–µ–±—ë–Ω–∫–∞" (value = childName state)
- Number input or Select: "–ì–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è" (value = birthYear, current year ¬± 18 range)
- Emoji picker grid (8 options in a 4√ó2 grid, each a button): üë¶ üëß üßí üë∂ ü¶∏ üß† ‚≠ê üèÜ. Selected emoji gets emerald ring (ring-2 ring-emerald-500). Default: üë¶.
- Primary button: "–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞"
- On click: call `addChildToFamily(wizardData.familyId, { displayName: childName, birthYear, avatarUrl: selectedEmoji }, userId)`, store inviteCode if not already stored (it's the family invite code), advance step

**Step 4 ‚Äî Invite Parent (or show invite code):**
- Heading: "–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –≤—Ç–æ—Ä–æ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è"
- Subheading: "–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º –∫–æ–¥–æ–º —Å —Å—É–ø—Ä—É–≥–æ–º(–æ–π)"
- Display family invite code in a styled box: large text, monospace font, letter-spacing wide, emerald border, copy button (üìã icon, on click: navigator.clipboard.writeText(inviteCode), show "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!" for 2s)
- Instructions: "–†–µ–±—ë–Ω–æ–∫ —Ç–æ–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ—Ç –∫–æ–¥ —á—Ç–æ–±—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è"
- Two buttons: "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å" (gray, text-only) and "–î–∞–ª–µ–µ" (emerald, primary). Both advance to step 5.
- On "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å": call `updateOnboardingStep(userId, 5)` and advance.
- On "–î–∞–ª–µ–µ": same.

**Steps 5-6 placeholder** (implemented in Plan 04 ‚Äî 01.2-04):
- If currentStep >= 5, show a simple loading placeholder: "–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥..." ‚Äî this will be replaced in Plan 04.

**State shape:**
```typescript
interface WizardData {
  userId: string
  familyId: string
  inviteCode: string
  parentName: string
  familyName: string
}
```

**Error handling per step:** if API call fails, show red error text below the primary button. Keep the user on the current step (do not advance).

**Back button behavior:** setDirection('backward'), setCurrentStep(currentStep - 1). Do NOT undo DB changes ‚Äî just navigate back in the UI.

**Loading state:** while submitting, disable the primary button and show a spinner (simple: text changes to "..." or use a CSS border-top spinner, Claude's discretion on implementation).
  </action>
  <verify>
    <automated>cd /Users/andrei/Desktop/kids-motivation && npx tsc --noEmit 2>&1 | grep "onboarding" | head -20; echo "TypeScript check done"</automated>
  </verify>
  <done>app/onboarding/page.tsx: wizard with progress bar, steps 0-4 fully implemented, steps 5-6 placeholder. DB calls use lib/onboarding-api.ts. TypeScript clean. Slide direction state tracked.</done>
</task>

</tasks>

<verification>
- /onboarding/welcome redirects to /onboarding instantly
- /onboarding shows progress bar (Step 1 of 7 on load)
- Step 0 (Welcome): shows intro content, –ù–∞—á–∞—Ç—å button advances
- Step 1 (Profile): name input, saves to DB on Next
- Step 2 (Family): family name input, creates family in DB, stores inviteCode
- Step 3 (Add Child): emoji picker + name/birth year, adds to DB
- Step 4 (Invite): shows invite code with copy button, Skip and Next both advance
- Reloading /onboarding resumes at correct step (DB persistence)
- TypeScript: `npx tsc --noEmit` passes
</verification>

<success_criteria>
1. Progress bar visible on all steps, fills correctly
2. Steps 0-4 fully functional with DB integration
3. Family invite code displayed on step 4 with working copy button
4. Refreshing /onboarding resumes at last completed step
5. Slide transitions work: forward slides in from right, back from left
6. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01.2-onboarding/01.2-03-SUMMARY.md`
</output>
