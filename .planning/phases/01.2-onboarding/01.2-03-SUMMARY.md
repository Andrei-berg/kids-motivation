---
phase: 01.2-onboarding
plan: "03"
subsystem: ui
tags: [react, nextjs, supabase, onboarding, wizard, storage, typescript]

# Dependency graph
requires:
  - phase: 01.2-01
    provides: "lib/onboarding-api.ts with getOnboardingStep, saveParentProfile, createFamily, addChildToFamily, updateOnboardingStep; Supabase avatars storage bucket"
  - phase: 01.2-02
    provides: "auth pages at /login and /register; middleware routing users to /onboarding/welcome"
provides:
  - "app/onboarding/welcome/page.tsx — instant redirect from /onboarding/welcome to /onboarding"
  - "app/onboarding/page.tsx — 7-step parent onboarding wizard with DB persistence, slide transitions, emoji picker, Supabase photo upload"
affects: [01.2-04, 01.2-05]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Wizard pattern: single URL /onboarding, step tracked in React state with DB persistence via getOnboardingStep on mount"
    - "Slide transition: direction state (forward/backward) drives translateX animation with 150ms exit + 300ms enter"
    - "Avatar selection: emoji grid (8 options with ring highlight) OR photo upload — mutually exclusive, upload deferred to submit"
    - "Step sub-components: each step is its own React component with local state where needed (StepAddChild manages its own form state)"

key-files:
  created:
    - app/onboarding/page.tsx
  modified:
    - app/onboarding/welcome/page.tsx

key-decisions:
  - "addChildToFamily actual signature is (familyId, parentUserId, child) — plan interface comment had swapped argument order; used the actual implementation"
  - "StepAddChild manages its own child-specific state (childName, birthYear, selectedEmoji, photoFile) rather than hoisting to WizardData — avoids polluting wizard state with transient child form fields"
  - "Photo upload happens at step 3 submit time (not on file select) to avoid orphaned Supabase Storage objects if user changes their mind"
  - "Back button hidden on step 0 (Welcome) and steps >= 5 (placeholder) — users cannot undo DB changes from steps 1-4 but can navigate UI freely"

patterns-established:
  - "Pattern: WizardData holds cross-step context (userId, familyId, inviteCode) — accumulated as user progresses through steps"
  - "Pattern: error state cleared on navigation, set on failed API call — users see errors inline below their submit button"
  - "Pattern: submitting boolean disables primary button and shows '...' text — consistent loading UX across all steps"

requirements-completed:
  - REQ-ONB-001
  - REQ-ONB-002
  - REQ-ONB-003
  - REQ-ONB-004
  - REQ-ONB-005
  - REQ-ONB-006
  - REQ-ONB-010
  - REQ-FAM-001
  - REQ-FAM-009

# Metrics
duration: 25min
completed: 2026-03-01
---

# Phase 1.2 Plan 03: Parent Onboarding Wizard Summary

**5-step parent wizard at /onboarding with DB-persisted step resumption, emoji avatar picker, Supabase Storage photo upload, slide transitions, and invite code sharing**

## Performance

- **Duration:** ~25 min
- **Started:** 2026-03-01T20:04:00Z
- **Completed:** 2026-03-01T20:29:07Z
- **Tasks:** 2 of 2 auto tasks complete
- **Files modified:** 2

## Accomplishments
- Created `app/onboarding/page.tsx` — 835-line wizard implementing steps 0-4 (Welcome, Profile, Family, Add Child, Invite Parent) plus placeholder for steps 5-6
- Updated `app/onboarding/welcome/page.tsx` to instantly redirect to /onboarding, keeping middleware target valid
- Progress bar ("Шаг N из 7") with animated emerald fill across all steps
- Emoji avatar picker (8 options, 4x2 grid, emerald ring on selected) + optional photo upload to Supabase Storage avatars bucket with thumbnail preview
- Invite code display with clipboard copy and "Скопировано!" confirmation, Skip + Next both advance to step 5
- DB persistence: `getOnboardingStep` on mount resumes wizard at last completed step after page refresh

## Task Commits

Each task was committed atomically:

1. **Task 1: Update welcome page redirect** - `6de519f` (feat)
2. **Task 2: Create onboarding wizard** - `e0c8fd7` (feat)

## Files Created/Modified
- `app/onboarding/welcome/page.tsx` — Replaced stub with instant router.replace('/onboarding'); keeps middleware target valid
- `app/onboarding/page.tsx` — Full 7-step wizard component: progress bar, steps 0-4 implemented, steps 5-6 placeholder; all DB calls via lib/onboarding-api.ts; photo upload via Supabase Storage; slide transitions

## Decisions Made
- The actual `addChildToFamily` function signature in `lib/onboarding-api.ts` is `(familyId, parentUserId, child)` — the plan's `<interfaces>` comment incorrectly showed `(familyId, child, parentUserId)`. Used the correct implementation signature.
- `StepAddChild` component manages its own local form state (childName, birthYear, emoji/photo selection) rather than hoisting everything to the top-level WizardData. This keeps wizard-level state clean and focused on cross-step data (userId, familyId, inviteCode).
- Photo upload is deferred to submission time (not triggered on file selection) to prevent orphaned objects in Supabase Storage if the user changes their mind before submitting.

## Deviations from Plan

None — plan executed exactly as written. The argument order discrepancy between the plan's interface comment and the actual API was resolved by using the actual implementation.

## Issues Encountered
None.

## User Setup Required
None — no additional external service configuration required. The Supabase avatars bucket was created in Plan 01 (`supabase/onboarding-patch.sql`).

## Next Phase Readiness
- Steps 0-4 are fully functional; step 5-6 shows a spinner placeholder
- Plan 04 (01.2-04) will implement steps 5-6: category/schedule setup
- All onboarding-api.ts functions used correctly with proper TypeScript types
- TypeScript compiles with 0 errors across the full project

---
*Phase: 01.2-onboarding*
*Completed: 2026-03-01*
