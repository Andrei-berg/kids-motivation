---
phase: 01.2-onboarding
plan: "05"
type: execute
wave: 3
depends_on:
  - "01.2-01"
files_modified:
  - app/onboarding/join/page.tsx
  - middleware.ts
autonomous: false
requirements:
  - REQ-ONB-009
  - REQ-FAM-003
  - REQ-FAM-008
  - REQ-FAM-009
  - REQ-FAM-010
  - REQ-AUTH-008

must_haves:
  truths:
    - "Child registers/logs in → middleware detects no family → redirects to /onboarding/join"
    - "Child enters 6-digit invite code → sees family profile preview ('Is this you?')"
    - "Child confirms profile → family_members row created → redirect to /dashboard"
    - "Invalid invite code shows inline error message"
    - "Middleware /onboarding redirect target updated to /onboarding (not /onboarding/welcome)"
  artifacts:
    - path: "app/onboarding/join/page.tsx"
      provides: "Child join flow: code entry → profile preview → confirm → /dashboard"
      min_lines: 100
    - path: "middleware.ts"
      provides: "Redirect updated from /onboarding/welcome to /onboarding"
  key_links:
    - from: "app/onboarding/join/page.tsx"
      to: "lib/onboarding-api.ts"
      via: "lookupFamilyByCode, joinFamilyAsChild"
      pattern: "lookupFamilyByCode|joinFamilyAsChild"
    - from: "middleware.ts"
      to: "/onboarding"
      via: "pathname redirect for no-family authenticated users"
      pattern: "url\\.pathname = '/onboarding'"
---

<objective>
Build the child join flow at /onboarding/join: a simple 2-screen experience (code entry → profile confirm) that adds a child to their family. Also update the middleware redirect target from /onboarding/welcome to /onboarding, which now handles the welcome/redirect itself.

Purpose: Every child member needs to join the family independently with their own account. This is their entire onboarding — lightweight, no wizard.
Output: /onboarding/join page + middleware correction.
</objective>

<execution_context>
@/Users/andrei/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andrei/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01.2-onboarding/01.2-CONTEXT.md
@.planning/phases/01.2-onboarding/01.2-01-SUMMARY.md
@middleware.ts

<interfaces>
<!-- From lib/onboarding-api.ts (Plan 01) -->
import { lookupFamilyByCode, joinFamilyAsChild } from '@/lib/onboarding-api'

// lookupFamilyByCode(code: string): Promise<FamilyLookup | null>
// FamilyLookup = { familyId: string, name: string }
// Returns null if no family found with that invite_code

// joinFamilyAsChild(
//   familyId: string,
//   userId: string,
//   { displayName: string }
// ): Promise<void>
// Inserts family_members row with role='child', sets onboarding_step=6

<!-- New function needed for join flow — ADD to lib/onboarding-api.ts: -->
// getFamilyChildren(familyId: string): Promise<ChildProfile[]>
// Fetches all family_members with role='child' for family preview
// ChildProfile = { memberId: string, displayName: string, avatarUrl: string | null }

// Why: after code lookup, child sees "Is this you?" with their profile listed.
// Parent has already added the child's name/avatar — child picks theirs.

<!-- From lib/supabase/client.ts -->
import { createClient } from '@/lib/supabase/client'
// supabase.auth.getUser() → current child's userId

<!-- Current middleware.ts redirect line (line 36-38): -->
// url.pathname = '/onboarding/welcome'
// This needs to change to: url.pathname = '/onboarding'
// /onboarding/join must be added to isOnboardingPath check

<!-- Design decisions from CONTEXT.md: -->
// Child join flow: "simple code-entry page, not a multi-step wizard"
// "just a big code-entry input"
// After code confirmed → show child profiles → confirm → /dashboard
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update middleware.ts and add lib/onboarding-api.ts getFamilyChildren function</name>
  <files>middleware.ts, lib/onboarding-api.ts</files>
  <action>
**1. Update middleware.ts:**

Change line `url.pathname = '/onboarding/welcome'` to `url.pathname = '/onboarding'`.

Also ensure `/onboarding/join` is covered by `isOnboardingPath`. The current check is:
```typescript
const isOnboardingPath = pathname.startsWith('/onboarding')
```
This already covers /onboarding/join since it starts with '/onboarding'. No change needed for the isOnboardingPath check.

But also add `/onboarding/join` to the isPublicPath check OR leave it as isOnboardingPath (auth-required but family-check exempt) — it IS auth-required, so isOnboardingPath is correct.

Verify the full updated redirect section reads:
```typescript
if (!membership) {
  const url = request.nextUrl.clone()
  url.pathname = '/onboarding'
  return NextResponse.redirect(url)
}
```

**2. Add getFamilyChildren to lib/onboarding-api.ts:**

```typescript
export interface ChildProfile {
  memberId: string
  displayName: string
  avatarUrl: string | null
}

export async function getFamilyChildren(familyId: string): Promise<ChildProfile[]> {
  const supabase = createClient()
  const { data, error } = await supabase
    .from('family_members')
    .select('id, display_name, avatar_url')
    .eq('family_id', familyId)
    .eq('role', 'child')
  if (error) throw new Error(error.message)
  return (data || []).map(row => ({
    memberId: row.id,
    displayName: row.display_name || 'Ребёнок',
    avatarUrl: row.avatar_url,
  }))
}
```

Also add `ChildProfile` to the exports of lib/onboarding-api.ts.
  </action>
  <verify>
    <automated>cd /Users/andrei/Desktop/kids-motivation && grep -q "url.pathname = '/onboarding'" middleware.ts && echo "middleware PASS" || echo "middleware FAIL"; npx tsc --noEmit 2>&1 | grep -E "middleware|onboarding-api|error TS" | head -10; echo "Done"</automated>
  </verify>
  <done>middleware.ts redirects to /onboarding (not /onboarding/welcome). lib/onboarding-api.ts exports getFamilyChildren + ChildProfile. TypeScript clean.</done>
</task>

<task type="auto">
  <name>Task 2: Create app/onboarding/join/page.tsx — child join flow</name>
  <files>app/onboarding/join/page.tsx</files>
  <action>
Create app/onboarding/join/ directory and page.tsx. This is a 'use client' page.

**Layout:** centered card (max-w-sm, mx-auto, mt-16), white bg, rounded-2xl, shadow-xl, p-8. No NavBar, no progress bar.

**Two screens managed with `screen: 'code' | 'confirm'` state:**

**Screen 1 — Code Entry:**
- App logo (same as login/register — "FamilyCoins" text in emerald-500)
- Heading: "Войти в семью" (text-xl font-bold)
- Subheading: "Введите код, который дал вам родитель" (gray-500, text-sm)
- Large 6-character input: single text input, uppercase auto-transform (`onChange: e => setValue(e.target.value.toUpperCase().slice(0, 6))`), text-center, text-2xl font-mono, letter-spacing-widest, rounded-xl, border-2, focus:border-emerald-500, h-16. Placeholder: "XXXXXX".
- "Найти семью" button (emerald-500, full width, disabled if value.length !== 6)
- Error text below button (red-500, text-sm) when lookup returns null
- On click: call `lookupFamilyByCode(code)`. If null: set error "Код не найден. Проверьте и попробуйте ещё раз." If found: store { familyId, familyName } in state, fetch `getFamilyChildren(familyId)`, set children in state, switch to 'confirm' screen.
- Small link at bottom: "Зарегистрироваться самому" → /register (in case they don't have an account yet — but if they landed here, they're already authenticated; this is just a fallback for edge cases)

**Screen 2 — Profile Confirm:**
- Back button (text-sm, gray-500) at top to return to Screen 1
- Heading: "Вы в семье: {familyName}" (text-xl font-bold)
- Subheading: "Выберите ваш профиль" (gray-500)
- Child profile cards (vertical list): each card shows avatar emoji (text-3xl) + display name (text-lg font-medium). Cards are selectable (click → ring-2 ring-emerald-500). State: `selectedChildId`.
- If no children listed (parent hasn't added any yet): show message "Родитель ещё не добавил детей. Попросите их сделать это сначала." with Back button only.
- "Это я!" button (emerald-500, full width, disabled if no selectedChildId)
- On click: get current user's auth ID (`supabase.auth.getUser()`), call `joinFamilyAsChild(familyId, userId, { displayName: selectedChild.displayName })`. On success: `router.push('/dashboard')`.
- Loading state while joining: disable button, show spinner text.
- Error handling: show red text if joinFamilyAsChild throws.

**State shape:**
```typescript
const [code, setCode] = useState('')
const [screen, setScreen] = useState<'code' | 'confirm'>('code')
const [familyName, setFamilyName] = useState('')
const [familyId, setFamilyId] = useState('')
const [children, setChildren] = useState<ChildProfile[]>([])
const [selectedChildId, setSelectedChildId] = useState<string | null>(null)
const [loading, setLoading] = useState(false)
const [error, setError] = useState<string | null>(null)
```

Import: `import { lookupFamilyByCode, getFamilyChildren, joinFamilyAsChild, ChildProfile } from '@/lib/onboarding-api'`
Import: `import { createClient } from '@/lib/supabase/client'`
Import: `import { useRouter } from 'next/navigation'`
  </action>
  <verify>
    <automated>cd /Users/andrei/Desktop/kids-motivation && test -f app/onboarding/join/page.tsx && echo "file exists" || echo "MISSING"; npx tsc --noEmit 2>&1 | grep -E "join|error TS" | head -15; echo "TypeScript done"</automated>
  </verify>
  <done>app/onboarding/join/page.tsx: 2-screen flow (code entry → profile select → /dashboard). ChildProfile list shows children added by parent. TypeScript clean.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Verify child join flow works end-to-end</name>
  <action>Human verification step: test code entry with invalid code (error), then valid code (profile list), confirm join creates family_members row and redirects to /dashboard.</action>
  <what-built>Child join flow at /onboarding/join + middleware redirect fix. Children can join their family by entering the 6-digit invite code, picking their profile, and landing on /dashboard.</what-built>
  <how-to-verify>
1. Run: `npm run dev`
2. Create a new test account (different from parent) in Supabase Dashboard → Authentication → Users, or register via /register
3. Log in as the new test account — verify middleware redirects to /onboarding (not /onboarding/welcome)
4. Navigate to /onboarding/join directly
5. Test invalid code: enter "XXXXXX" → verify "Код не найден" error appears
6. Enter the real family invite code (from step 4 of the parent wizard, or from Supabase → families table → invite_code column)
7. Verify: family name appears ("Вы в семье: {name}"), child profiles listed
8. Select a child profile → click "Это я!" → verify redirect to /dashboard
9. In Supabase Dashboard → Table Editor → family_members: verify new row with role='child' and the test user's auth UID
10. Run: `npx tsc --noEmit` → 0 errors
  </how-to-verify>
  <resume-signal>Type "approved" once child can join family end-to-end, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- middleware.ts: no-family authenticated users → /onboarding (not /onboarding/welcome)
- /onboarding/join: 6-char code input, uppercase auto-transform, 6-char validation
- Invalid code → inline error, no page navigation
- Valid code → shows family name + child profile list
- Child selects profile → joinFamilyAsChild called → family_members row created → /dashboard
- TypeScript: `npx tsc --noEmit` passes
</verification>

<success_criteria>
1. middleware.ts redirects to /onboarding (confirmed by grep)
2. /onboarding/join renders: logo, heading, code input, button
3. Invalid invite code shows error message (no crash)
4. Valid invite code shows family name and child profiles
5. Child selects profile + confirms → family_members row in DB with role='child'
6. After join: /dashboard loads with correct family data
7. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01.2-onboarding/01.2-05-SUMMARY.md`
</output>
