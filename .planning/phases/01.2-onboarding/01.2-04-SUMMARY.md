---
phase: 01.2-onboarding
plan: "04"
subsystem: ui
tags: [react, nextjs, supabase, onboarding, wizard, confetti, typescript]

# Dependency graph
requires:
  - phase: 01.2-03
    provides: "app/onboarding/page.tsx with steps 0-4 implemented; WizardData cross-step context; DB persistence via updateOnboardingStep; placeholder for steps 5-6"
  - phase: 01.2-01
    provides: "lib/onboarding-api.ts with updateOnboardingStep; Supabase schema with onboarding_step column"
provides:
  - "app/onboarding/page.tsx — Complete 7-step wizard: steps 5 (category toggles, UI-only) and 6 (confetti + Done screen) implemented; wizard navigates to /dashboard on completion"
affects: [01.2-05, 01.3-categories-schedule]

# Tech tracking
tech-stack:
  added:
    - canvas-confetti (npm) — confetti burst animation on Done screen
    - "@types/canvas-confetti — TypeScript types for canvas-confetti"
  patterns:
    - "Category toggle card: 2x2 grid of toggle cards (emoji + name + description), emerald border/bg when selected, gray border/white when unselected — all ON by default"
    - "Confetti trigger: useEffect fires confetti() when currentStep === 6; canvas-confetti imported directly in 'use client' component"
    - "Done screen summary card: bg-gray-50 rounded-xl shows parentName, familyName, inviteCode from WizardData; copy button reuses clipboard pattern from Step 4"
    - "Category persistence deferred: Step 5 only calls updateOnboardingStep(userId, 5); actual category seeding is Phase 1.3 responsibility"

key-files:
  created: []
  modified:
    - app/onboarding/page.tsx

key-decisions:
  - "Category selections NOT persisted to DB in Phase 1.2 — Step 5 calls only updateOnboardingStep(userId, 5). Phase 1.3 must seed default categories (Учёба, Дом, Спорт, Распорядок) for all families unconditionally when category tables are created."
  - "Confetti fires immediately on step 6 enter via useEffect — no delay before animation, button click navigates to /dashboard"
  - "Back button removed from steps 5-6 — users cannot undo DB operations from prior steps and Done is a terminal screen"
  - "DB fixes applied during testing: onboarding_step column type fix, RLS policies replaced with security-definer helpers, families.created_by added for post-insert visibility, family_members.user_id made nullable for child profiles"

patterns-established:
  - "Pattern: Terminal wizard step has no Back button; Done screen is always a forward-only screen"
  - "Pattern: Deferred feature documented explicitly in SUMMARY.md with exact instruction for next phase executor"

requirements-completed:
  - REQ-ONB-007
  - REQ-ONB-008
  - REQ-ONB-010

# Metrics
duration: ~60min (including human verification and DB fixes)
completed: 2026-03-02
---

# Phase 1.2 Plan 04: Onboarding Wizard Steps 5-6 Summary

**7-step parent onboarding wizard completed with canvas-confetti Done screen, category toggle UI, and /dashboard redirect — fully functional end-to-end after 4 DB schema/RLS fixes during human verification**

## Performance

- **Duration:** ~60 min (including human verification and multiple DB fix rounds)
- **Started:** 2026-03-02
- **Completed:** 2026-03-02
- **Tasks:** 2 of 2 complete (1 auto + 1 checkpoint:human-verify)
- **Files modified:** 1

## Accomplishments
- Implemented Step 5 (Categories): 4 toggle cards in a 2x2 grid (Учёба, Дом, Спорт, Распорядок) with emerald selection state, all ON by default, no DB persistence in Phase 1.2
- Implemented Step 6 (Done): canvas-confetti burst on step enter, summary card showing parent name / family name / invite code with copy button, "Перейти в приложение" button navigating to /dashboard
- Progress bar shows "Шаг 7 из 7" with 100% fill on the Done screen
- Full wizard end-to-end verified by human tester: all 7 steps functional, DB rows created, confetti fires, redirect to /dashboard works
- 4 DB schema/RLS issues discovered during testing and resolved (see Deviations)

## Task Commits

Each task was committed atomically:

1. **Task 1: Install canvas-confetti and add Steps 5-6 to onboarding wizard** - `0a173bf` (feat)
2. **Task 2: Verify complete 7-step wizard end-to-end** - Checkpoint human-verify — APPROVED

**DB fix commits (auto-fixed during testing):**
- `85a76ce` — fix(schema): make family_members.user_id nullable for pre-registered child profiles
- `92b6e6b` — fix(rls): add families.created_by for post-insert visibility before member row exists
- `ce7a477` — fix(rls): replace recursive family_members policies with security definer helpers
- `0ce79a0` — fix(01.2-03): set userId before getOnboardingStep to prevent empty uuid on error

## Files Created/Modified
- `app/onboarding/page.tsx` — Steps 5-6 implemented replacing the spinner placeholder; canvas-confetti import added; WizardData summary card on Done screen; router.push('/dashboard') on completion

## Decisions Made
- **Category persistence deferred to Phase 1.3:** Step 5 only advances `onboarding_step` to 5 in DB. Phase 1.3 (categories-schedule) must seed all 4 default categories for every family unconditionally when category tables are created. The wizard toggle UI serves as user education only in Phase 1.2.
- **Confetti fires immediately on step enter:** `useEffect` with `[currentStep]` dependency fires `confetti()` as soon as step 6 is reached — no delay or interaction required before the animation.
- **No Back button on steps 5-6:** Category selection (step 5) and Done (step 6) are terminal steps. DB operations from earlier steps (family creation, child add) cannot be undone via UI navigation.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] RLS recursive policy caused infinite loop on family_members queries**
- **Found during:** Task 2 (human verification testing)
- **Issue:** The `family_members` RLS policies used `IN (SELECT family_id FROM family_members WHERE user_id = auth.uid())` which Postgres evaluates recursively, causing stack overflow / query failure
- **Fix:** Replaced RLS policies with `SECURITY DEFINER` helper functions (`get_my_family_ids()`) that bypass RLS when checking membership, eliminating recursion
- **Files modified:** Supabase SQL (applied via Dashboard SQL Editor) — `rls.sql` equivalent
- **Committed in:** `ce7a477`

**2. [Rule 2 - Missing Critical] families.created_by column missing — parent could not see own family after insert**
- **Found during:** Task 2 (human verification testing)
- **Issue:** After INSERT into `families`, the parent's user_id wasn't stored — RLS for SELECT relied only on `family_members`, but the `family_members` row wasn't created yet at query time, causing 0 rows returned for newly created families
- **Fix:** Added `created_by UUID REFERENCES auth.users(id)` column to `families` table; updated RLS policy to also allow SELECT if `created_by = auth.uid()`
- **Files modified:** Supabase SQL (applied via Dashboard) — `families` table DDL and RLS
- **Committed in:** `92b6e6b`

**3. [Rule 1 - Bug] family_members.user_id NOT NULL prevented child profile creation**
- **Found during:** Task 2 (human verification testing)
- **Issue:** Child profiles added during onboarding have no Supabase Auth user yet (children join later via invite code). `user_id NOT NULL` constraint rejected the INSERT.
- **Fix:** Made `family_members.user_id` nullable — child rows are created without a user_id and linked to an auth user when the child joins via invite code
- **Files modified:** Supabase SQL (applied via Dashboard) — `family_members` table DDL
- **Committed in:** `85a76ce`

**4. [Rule 1 - Bug] userId empty string when getOnboardingStep called before auth resolution**
- **Found during:** Task 2 (human verification testing)
- **Issue:** `getOnboardingStep('')` was called with empty string because `userId` state wasn't set yet when the initial `useEffect` ran — caused empty UUID error in Supabase
- **Fix:** Moved `setUserId(user.id)` before the `getOnboardingStep` call in the effect
- **Files modified:** `app/onboarding/page.tsx` (via prior commit `0ce79a0`)
- **Committed in:** `0ce79a0`

---

**Total deviations:** 4 auto-fixed (2 bugs, 1 missing critical, 1 bug)
**Impact on plan:** All fixes necessary for correctness and security. No scope creep. Wizard is now fully functional end-to-end.

## Issues Encountered
- The wizard required 4 DB-level fixes before it was fully functional — RLS policies, schema columns, and auth timing. These were found during human verification and fixed iteratively. The fixes have been committed and the schema is now correct for Phase 1.3 to build on.

## User Setup Required
None — all DB fixes applied during this plan's execution. No additional external service configuration required.

## Note for Phase 1.3 Executor

**IMPORTANT:** Category selections on Step 5 are NOT persisted to the database in Phase 1.2. Phase 1.3 (categories-schedule) must seed default categories for every family. The simplest approach is to seed all 4 defaults (`Учёба`, `Дом`, `Спорт`, `Распорядок`) unconditionally when the Phase 1.3 category tables are created — the wizard UI step serves as user education only in Phase 1.2.

## Next Phase Readiness
- Complete 7-step onboarding wizard is functional and tested end-to-end
- DB schema is stable: `onboarding_step`, `families.created_by`, `family_members.user_id` nullable, RLS security-definer helpers
- Plan 05 (01.2-05) can now implement the child join flow at `/onboarding/join` — family already created, invite code already visible on Step 5
- Phase 1.3 must create category tables and seed defaults for all families

---
*Phase: 01.2-onboarding*
*Completed: 2026-03-02*
