# CODEBASE-ANALYSIS.md ‚Äî –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–¥–∞

> –î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: 2026-03-01

---

## –ß—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ)

### ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
| –ß—Ç–æ | –§–∞–π–ª | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|---|---|---|
| –î–≤–∏–∂–æ–∫ –º–æ–Ω–µ—Ç | `lib/api.ts:getWeekScore()` | –°—á–∏—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –∏–∑ raw –¥–∞–Ω–Ω—ã—Ö, –±–µ–∑ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ |
| –°—Ç—Ä–∏–∫–∏ | `lib/streaks.ts` | 3 —Ç–∏–ø–∞ (room/study/sport), –ª–æ–≥–∏–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è |
| –ë–µ–π–¥–∂–∏ | `lib/badges.ts` | 6 –±–µ–π–¥–∂–µ–π, XP —Å–∏—Å—Ç–µ–º–∞, –∞–≤—Ç–æ–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ |
| –ö–æ—à–µ–ª—ë–∫ | `lib/wallet-api.ts` | –ü–æ–ª–Ω—ã–π CRUD: –ø–æ–∫—É–ø–∫–∏, –æ–±–º–µ–Ω, P2P, –≤—ã–≤–æ–¥ |
| –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ | `app/analytics/page.tsx` | 8 –Ω–µ–¥–µ–ª—å, –≥—Ä–∞—Ñ–∏–∫–∏, KPI ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ |
| Wallboard | `app/wallboard/page.tsx` | Live view —Å–µ–º—å–∏, 30-—Å–µ–∫ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ |
| DailyModal | `components/DailyModal.tsx` | Single-scroll, batched save ‚Äî —Ö–æ—Ä–æ—à–∞—è UX |
| –†–∞—Å—Ö–æ–¥—ã | `lib/expenses-api.ts` + —Å—Ç—Ä–∞–Ω–∏—Ü–∞ | –ü–æ–ª–Ω—ã–π CRUD, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —Å–µ–∫—Ü–∏–∏ |
| –ì–∏–±–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ | `lib/flexible-api.ts` | –ü—Ä–µ–¥–º–µ—Ç—ã, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è ‚Äî —É–∂–µ –≥–∏–±–∫–æ |
| CSS –¥–∏–∑–∞–π–Ω | `app/globals.css` | –í—Å–µ –∫–ª–∞—Å—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è, –∫—Ä–∞—Å–∏–≤—ã–π –¥–∏–∑–∞–π–Ω |
| –ö–æ–Ω—Ñ–µ—Ç—Ç–∏ | `utils/confetti.ts` | –ì–æ—Ç–æ–≤–æ |
| TypeScript —Ç–∏–ø—ã | –í–µ–∑–¥–µ | –•–æ—Ä–æ—à–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è |

### ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å –¥–æ—Ä–∞–±–æ—Ç–∫–æ–π
| –ß—Ç–æ | –§–∞–π–ª | –ß—Ç–æ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å |
|---|---|---|
| NavBar | `components/NavBar.tsx` | –£–±—Ä–∞—Ç—å hardcoded 'adam'/'alim', –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∏ –∏–∑ –ë–î |
| Store | `lib/store.ts` | `childId: string` –≤–º–µ—Å—Ç–æ `'adam' \| 'alim'`, –¥–æ–±–∞–≤–∏—Ç—å `familyId` |
| DailyModal | `components/DailyModal.tsx` | –£–±—Ä–∞—Ç—å hardcoded –ª–æ–≥–∏–∫—É, –ø—Ä–∏–≤—è–∑–∞—Ç—å –∫ –≥–∏–±–∫–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º |
| Dashboard | `app/dashboard/page.tsx` | –£–±—Ä–∞—Ç—å hardcoded –∏–º–µ–Ω–∞, –¥–æ–±–∞–≤–∏—Ç—å auth guard |
| Wallet page | `app/wallet/page.tsx` | –£–±—Ä–∞—Ç—å `'adam' \| 'alim'` union type |
| Goals | `components/GoalsModal.tsx` | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è |

### üî¥ –ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é
| –ß—Ç–æ | –§–∞–π–ª | –ü–æ—á–µ–º—É |
|---|---|---|
| Auth | –ù–µ—Ç | –ï–≥–æ –Ω–µ—Ç! –í—Å—ë –ø—É–±–ª–∏—á–Ω–æ |
| –°—Ö–µ–º–∞ –ë–î | `supabase-schema-v2.sql` | –ù–µ—Ç families, –Ω–µ—Ç user_accounts, –Ω–µ—Ç RLS |
| `children` —Ç–∞–±–ª–∏—Ü–∞ | SQL | `id TEXT = 'adam'/'alim'` ‚Üí –Ω—É–∂–µ–Ω UUID |
| Onboarding | –ù–µ—Ç | –ï–≥–æ –Ω–µ—Ç |
| `/kid/page.tsx` | –£–¥–∞–ª–∏—Ç—å | –ú—ë—Ä—Ç–≤—ã–π –∫–æ–¥ |
| `DailyModal-old.tsx` | –£–¥–∞–ª–∏—Ç—å | –ú—ë—Ä—Ç–≤—ã–π –∫–æ–¥ |

---

## –¢–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞ –ë–î (15 —Ç–∞–±–ª–∏—Ü)

```
children            ‚Üí –ü–ï–†–ï–ü–ò–°–ê–¢–¨ (–¥–æ–±–∞–≤–∏—Ç—å family_id, UUID)
settings            ‚Üí –ü–ï–†–ï–ü–ò–°–ê–¢–¨ (–ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ wallet_settings)
days                ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨ (–¥–æ–±–∞–≤–∏—Ç—å family_id, FK –Ω–∞ users)
subject_grades      ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
subjects_cache      ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
home_sports         ‚Üí –û–°–¢–ê–í–ò–¢–¨ (legacy, –Ω–µ —Ç—Ä–æ–≥–∞–µ–º)
home_exercises      ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
exercise_types      ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨ (–¥–æ–±–∞–≤–∏—Ç—å family_id)
sports_sections     ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
section_attendance  ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
goals               ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
goal_log            ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
weeks               ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
streaks             ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
badges              ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
records             ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
wallet              ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
wallet_transactions ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
rewards             ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
reward_purchases    ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
coin_exchanges      ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
cash_withdrawals    ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
wallet_settings     ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨ (–¥–æ–±–∞–≤–∏—Ç—å family_id)
p2p_transfers       ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
expenses            ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
expense_categories  ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨ (family_id + –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–µ—Ñ–æ–ª—Ç—ã)
sections            ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
section_visits      ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
subjects            ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨
schedule            ‚Üí –ú–ò–ì–†–ò–†–û–í–ê–¢–¨

–î–û–ë–ê–í–ò–¢–¨ –ù–û–í–´–ï:
families            ‚Üí –ù–û–í–ê–Ø
family_members      ‚Üí –ù–û–í–ê–Ø (user_id + family_id + role)
user_profiles       ‚Üí –ù–û–í–ê–Ø
invites             ‚Üí –ù–û–í–ê–Ø (–∫–æ–¥—ã –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π)
subscriptions       ‚Üí –ù–û–í–ê–Ø (Stripe)
messages            ‚Üí –ù–û–í–ê–Ø (—á–∞—Ç)
```

---

## Hardcoded –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫

### –í –∫–æ–¥–µ TypeScript:
```typescript
// lib/store.ts
childId: 'adam' | 'alim'

// lib/api.ts ‚Äî –º–æ–Ω–µ—Ç—ã –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω—ã
const GRADE_COINS = { 5: 5, 4: 3, 3: -3, 2: -5, 1: -10 }
room_ok * 3         // +3 –∑–∞ –∫–æ–º–Ω–∞—Ç—É
good_behavior * 5   // +5 –∑–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

// lib/wallet-api.ts
from_child: 'adam', to_child: 'alim'  // P2P

// components/NavBar.tsx
<option value="adam">üë¶ –ê–¥–∞–º</option>
<option value="alim">üë∂ –ê–ª–∏–º</option>

// app/expenses/page.tsx
return childId === 'adam' ? '–ê–¥–∞–º' : '–ê–ª–∏–º'
```

### –í SQL:
```sql
-- —Å—É–º–º—ã –≤ COINS
INSERT INTO settings VALUES ('per5', 5), ('per4', 3), ('pen3', -3)...
INSERT INTO children VALUES ('adam', '–ê–¥–∞–º', 'üë¶', 11)...
INSERT INTO children VALUES ('alim', '–ê–ª–∏–º', 'üë∂', 9)...
```

---

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (package.json)

**–û—Å—Ç–∞–≤–ª—è–µ–º:**
- `next 14`, `react 18` ‚Äî –æ—Å–Ω–æ–≤–∞
- `@supabase/supabase-js 2.39` ‚Äî –ë–î –∏ auth
- `zustand 4.5` ‚Äî —Å—Ç–µ–π—Ç
- `chart.js 4.4` + `react-chartjs-2` ‚Äî –≥—Ä–∞—Ñ–∏–∫–∏
- `date-fns 3` ‚Äî –¥–∞—Ç–∞ —É—Ç–∏–ª–∏—Ç—ã
- `canvas-confetti` ‚Äî –∫–æ–Ω—Ñ–µ—Ç—Ç–∏

**–î–æ–±–∞–≤–ª—è–µ–º:**
- `framer-motion` ‚Äî –∞–Ω–∏–º–∞—Ü–∏–∏ (–ø–æ–ª—É—á–µ–Ω–∏–µ –º–æ–Ω–µ—Ç, –ø–µ—Ä–µ—Ö–æ–¥—ã)
- `next-pwa` –∏–ª–∏ —Ä—É—á–Ω–æ–π Service Worker ‚Äî PWA
- `stripe` ‚Äî –ø–æ–¥–ø–∏—Å–∫–∏ (–ø–æ–∑–∂–µ)
- `react-hot-toast` –∏–ª–∏ `sonner` ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

---

## –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ü–ï–†–í–´–ú (Milestone 1)

### –®–∞–≥ 1: –ù–æ–≤–∞—è —Å—Ö–µ–º–∞ –ë–î
1. –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã: `families`, `family_members`, `user_profiles`
2. –ò–∑–º–µ–Ω–∏—Ç—å `children` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å `family_id UUID`, `user_id UUID`
3. –î–æ–±–∞–≤–∏—Ç—å `family_id` –≤–æ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å RLS (Row Level Security) ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–æ!
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ê–¥–∞–º–∞ –∏ –ê–ª–∏–º–∞ —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏—é

### –®–∞–≥ 2: Auth
1. –í–∫–ª—é—á–∏—Ç—å Supabase Auth (email + Google)
2. `middleware.ts` ‚Äî redirect –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞ /login
3. –°–æ–∑–¥–∞—Ç—å `/login` –∏ `/register` —Å—Ç—Ä–∞–Ω–∏—Ü—ã

### –®–∞–≥ 3: Onboarding
1. –°–æ–∑–¥–∞—Ç—å `/onboarding/welcome`, `/onboarding/family`, `/onboarding/children`
2. –õ–æ–≥–∏–∫–∞: —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ–º—å–∏ ‚Üí –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–µ–π ‚Üí redirect –Ω–∞ /dashboard

### –®–∞–≥ 4: –£–±—Ä–∞—Ç—å hardcodes
1. `store.ts`: `childId: string` (UUID), –¥–æ–±–∞–≤–∏—Ç—å `familyId: string`
2. –í—Å–µ API —Ñ—É–Ω–∫—Ü–∏–∏: –ø—Ä–∏–Ω–∏–º–∞—é—Ç `familyId` + `childId` (UUID)
3. `NavBar`: –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–µ–π –∏–∑ –ë–î
4. –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: `child.name` –∏–∑ –ë–î, –Ω–µ —Ö–∞—Ä–¥–∫–æ–¥

---

## –û—Ü–µ–Ω–∫–∞ –æ–±—ä—ë–º–∞ —Ä–∞–±–æ—Ç—ã

| –ó–∞–¥–∞—á–∞ | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –í—Ä–µ–º—è |
|---|---|---|
| –ù–æ–≤–∞—è —Å—Ö–µ–º–∞ –ë–î + RLS | –í—ã—Å–æ–∫–∞—è | Phase 1.1 |
| Auth (login/register) | –°—Ä–µ–¥–Ω—è—è | Phase 1.2 |
| Onboarding flow | –°—Ä–µ–¥–Ω—è—è | Phase 1.2 |
| –£–±—Ä–∞—Ç—å hardcodes | –°—Ä–µ–¥–Ω—è—è | Phase 1.3 |
| –ì–∏–±–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ | –°—Ä–µ–¥–Ω—è—è | Phase 1.3 |
| –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ + push | –í—ã—Å–æ–∫–∞—è | Phase 1.3 |
| –ú–∞–≥–∞–∑–∏–Ω (—É–∂–µ –µ—Å—Ç—å!) | –ú–∞–ª–∞—è | Phase 2.2 |
| –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (—É–∂–µ –µ—Å—Ç—å!) | –ú–∞–ª–∞—è | Phase 2.4 |
| –ß–∞—Ç (Supabase Realtime) | –°—Ä–µ–¥–Ω—è—è | Phase 3.2 |
| PWA | –°—Ä–µ–¥–Ω—è—è | Phase 4.1 |
| Stripe | –°—Ä–µ–¥–Ω—è—è | Phase 5.2 |

**–•–æ—Ä–æ—à–∞—è –Ω–æ–≤–æ—Å—Ç—å:** ~60% —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ. –û—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Äî —ç—Ç–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä (auth + multi-tenant), –∞ –Ω–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞.

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: 2026-03-01.*
